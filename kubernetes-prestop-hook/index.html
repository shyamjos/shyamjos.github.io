<!doctype html><html lang=en><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=generator content="Hugo 0.75.1"><title>HPA - How to gracefully scale down pods with PreStop hooks</title><meta name=description content="Hey I am Shyam Jos. Welcome to my personal blog, where I write about Linux, DevOps, Cloud and Automation."><meta name=keywords content="DevOps,linux,cloud,automation,sysadmin,blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://shyamjos.com/assets/img/featured.jpg"><meta name=twitter:title content="HPA - How to gracefully scale down pods with PreStop hooks"><meta name=twitter:description content="Kubernetes provides container lifecycle hook framework to run code triggered by events during their management lifecycle called PostStart and PreStop hooks"><meta property="og:title" content="HPA - How to gracefully scale down pods with PreStop hooks"><meta property="og:description" content="Kubernetes provides container lifecycle hook framework to run code triggered by events during their management lifecycle called PostStart and PreStop hooks"><meta property="og:type" content="article"><meta property="og:url" content="https://shyamjos.com/kubernetes-prestop-hook/"><meta property="og:image" content="https://shyamjos.com/assets/img/featured.jpg"><meta property="article:published_time" content="2021-09-30T00:00:00+00:00"><meta property="article:modified_time" content="2021-09-30T00:00:00+00:00"><meta property="og:site_name" content="Shyam Jos"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css><link rel=stylesheet href=/scss/hyde-hyde.9f3dcd4b374222cbcb96f60c7bb789ffc4f9d212be47670cde56786b87968cbd.css integrity="sha256-nz3NSzdCIsvLlvYMe7eJ/8T50hK+R2cM3lZ4a4eWjL0="><link rel=stylesheet href=/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58+TzH3icCkSHGoJ+ed7w=" media=print><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=apple-touch-icon-precomposed sizes=144x144 href=/assets/img/apple-touch-icon.png><link rel="shortcut icon" href=/assets/img/favicon.ico><script>if(!sessionStorage.getItem("_swa")&&document.referrer.indexOf(location.protocol+"//"+location.host)!==0){fetch("https://counter.dev/track?"+new URLSearchParams({referrer:document.referrer,screen:screen.width+"x"+screen.height,user:"shyamjosepp@gmail.com",utcoffset:"6"}))};sessionStorage.setItem("_swa","1");</script></head><body><div class=sidebar><div class=container><div class=sidebar-about><span class=site__title><a href=https://shyamjos.com/>Shyam Jos</a></span><div class=author-image><img src=https://shyamjos.com/assets/img/shyam_jos_photo.jpeg alt="Author Image" class="img--circle img--headshot element--center"></div><p class=site__description>Random Bits From A SRE/DevOps Engineer</p></div><div class=collapsible-menu><input type=checkbox id=menuToggle>
<label for=menuToggle>Shyam Jos</label><div class=menu-content><div><ul class=sidebar-nav><li><a href=/><span>Blog</span></a></li><li><a href=/about/><span>About</span></a></li></ul></div><section class=social><a href=https://twitter.com/shyamjose rel=me><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a><a href=https://github.com/shyamjos rel=me><i class="fab fa-github fa-lg" aria-hidden=true></i></a><a href=https://linkedin.com/in/shyamjos rel=me><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a><a href=https://stackoverflow.com/users/2460764 rel=me><i class="fab fa-stack-overflow fa-lg" aria-hidden=true></i></a><a href=mailto:shyamjosepp+website@gmail.com rel=me><i class="fas fa-at fa-lg" aria-hidden=true></i></a></section></div></div><div class=copyright>&copy; 2022 Shyam Jos</div></div></div><div class="content container"><article><header><h1>HPA - How to gracefully scale down pods with PreStop hooks</h1><div class=post__meta><i class="fas fa-calendar-alt"></i>30 Sep, 2021<br><i class="fas fa-tags"></i><a class="badge badge-tag" href=/tags/kubernetes>kubernetes</a>
<a class="badge badge-tag" href=/tags/container>container</a><br><i class="fas fa-clock"></i>2 min read</div></header><div class=post><p>One of our application running in kubernetes have a background job feature (which is a bad practice and against stateless architecture) and recently we noticed some of these background jobs were killed in midway due to pod scale-down done by horizontal pod autoscaler. Our assumption was Kubernetes will only terminate pods with less utilization but we were wrong! and its a random selection.</p><p>In order to handle this issue we found out that we can use prestop hook feature in kubernetes to check for any background process running in container and wait for it to complete before sending termination signal.</p><h2 id=how-prestop-hooks-works-in-kubernetes>How PreStop hooks works in kubernetes</h2><p>Kubernetes provides container lifecycle hook framework to run code triggered by events during their management lifecycle called PostStart and PreStop hooks. A PreStop hook is called immediately before sending termination signal and kubernetes will wait until the PreStop hook to complete or until it exceed the <code>terminationGracePeriodSeconds</code> value, Only after this kubernetes will sent the termination signal to the container.</p><h2 id=our-solution>Our solution</h2><p>Our solution was to use a bash script for PreStop hook which will check for <code>.lock</code> files created by the background process, if it finds a <code>.lock</code> file the script will wait for the <code>.lock</code> file to be removed and when the file is removed the script will exit then the container will receive termination signal. If the PreStop hook takes more time than <code>terminationGracePeriodSeconds</code> value then container will be terminated immediately once this value is crossed.</p><h3 id=prestop-hook-bash-script>PreStop hook bash script</h3><pre><code>#PreStop Script for checking background php tasks 
SECONDS=0
while true
do	
if [ -z &quot;$(ls -A /app/demo-web/public/lock/*.lock 2&gt; /dev/null)&quot; ]; then
   echo &quot;No lock files found!, container is safe to terminate [Time Elapsed: ${SECONDS}s].&quot;
   exit 0
else
   echo &quot;Lock files found!, waiting for backgound process to complete [Time Elapsed: ${SECONDS}s].&quot;
   sleep 10
fi
done &gt; /proc/1/fd/1 # sent outputs to conatiner's stdout
</code></pre><h3 id=final-deployment-yaml>Final deployment yaml</h3><pre><code>apiVersion: apps/v1
kind: Deployment
metadata:
  name: demo-web
  namespace: production
spec:
  progressDeadlineSeconds: 300
  revisionHistoryLimit: 5
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 5
      maxUnavailable: 0
  selector:
    matchLabels:
      app: demo-web
      tier: web
      environment: production 
  template:
    metadata:
      labels:
        app: demo-web
        tier: web
        environment: production
    spec:
      terminationGracePeriodSeconds: 300
      containers:
      - name: demo-web
        image: demo/demoweb:v1
        lifecycle:
          preStop :
             exec:
               command: [&quot;bash&quot;, &quot;/app/scripts/prestop.sh&quot;]           
        imagePullPolicy: Always
        resources:
          requests:
            cpu: 50m
            memory: 150Mi
          limits:
            memory: &quot;650Mi&quot; 
        ports:
        - containerPort: 80
        readinessProbe:
         httpGet:
          path: /healthz
          port: 80
         initialDelaySeconds: 2
         periodSeconds: 5
         successThreshold: 1
         failureThreshold: 2
         timeoutSeconds: 2
        env:
         - name: HOST 
           value: &quot;demo.app.com&quot;
</code></pre></div><script type=text/javascript src=https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js data-name=bmc-button data-slug=shyamjos data-color=#deddda data-emoji data-font=Bree data-text="Buy me a coffee" data-outline-color=#000000 data-font-color=#000000 data-coffee-color=#FFDD00></script><div class="navigation navigation-single"><a href=/redirect-prestop-hook-logs/ class=navigation-prev><i aria-hidden=true class="fa fa-chevron-left"></i><span class=navigation-tittle>How to redirect PreStop hook output to pod logs</span></a></div><div class=post__related><h2>Related Articles</h2><ul class=related-posts><li><span class=list__title--small><a href=/redirect-prestop-hook-logs/>How to redirect PreStop hook output to pod logs</a>
<time class="pull-right hidden-tablet">25 Sep, 2021</time></span></li><li><span class=list__title--small><a href=/redirecting-codeigniter-logs-to-container-stdout-stderr/>Redirect CodeIgniter logs to container's STDOUT/ERR</a>
<time class="pull-right hidden-tablet">20 Aug, 2021</time></span></li></ul></div><div id=disqus_thread></div><script type=text/javascript>(function(){if(location.hostname==="localhost"||location.hostname==="127.0.0.1"||location.hostname===""){return;}
var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;var disqus_shortname='shyamjos';dsq.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);})();</script><noscript>Please enable JavaScript to view the
<a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=http://disqus.com/ class=dsq-brlink>comments powered by
<span class=logo-disqus>Disqus</span></a></article></div><script defer src=https://use.fontawesome.com/releases/v5.12.1/js/all.js integrity=sha384-ZbbbT1gw3joYkKRqh0kWyRp32UAvdqkpbLedQJSlnI8iLQcFVxaGyrOgOJiDQTTR crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js></script><script type=text/javascript>hljs.initHighlightingOnLoad();</script></body></html>