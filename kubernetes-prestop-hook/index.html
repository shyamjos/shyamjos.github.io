<!doctype html><html lang=en>
<head>
<link href=https://gmpg.org/xfn/11 rel=profile>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1">
<meta name=generator content="Hugo 0.93.3">
<title>HPA - How to gracefully scale down pods with PreStop hooks</title><meta name=description content="Hey I am Shyam Jos. Welcome to my personal blog, where I write about Linux, DevOps, Cloud and Automation.">
<meta name=keywords content="DevOps,linux,cloud,automation,sysadmin,blog">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://shyamjos.com/assets/img/featured.jpg">
<meta name=twitter:title content="HPA - How to gracefully scale down pods with PreStop hooks">
<meta name=twitter:description content="Kubernetes provides container lifecycle hook framework to run code triggered by events during their management lifecycle called PostStart and PreStop hooks">
<meta property="og:title" content="HPA - How to gracefully scale down pods with PreStop hooks">
<meta property="og:description" content="Kubernetes provides container lifecycle hook framework to run code triggered by events during their management lifecycle called PostStart and PreStop hooks">
<meta property="og:type" content="article">
<meta property="og:url" content="https://shyamjos.com/kubernetes-prestop-hook/"><meta property="og:image" content="https://shyamjos.com/assets/img/featured.jpg"><meta property="article:section" content="post">
<meta property="article:published_time" content="2021-09-30T00:00:00+00:00">
<meta property="article:modified_time" content="2021-09-30T00:00:00+00:00"><meta property="og:site_name" content="Shyam Jos">
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css>
<link rel=stylesheet href=/scss/hyde-hyde.9b73eed3365e0428f1d3e83334e49b32658041c057b59f501476f1fd26a261df.css integrity="sha256-m3Pu0zZeBCjx0+gzNOSbMmWAQcBXtZ9QFHbx/SaiYd8=">
<link rel=stylesheet href=/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58+TzH3icCkSHGoJ+ed7w=" media=print><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js></script>
<script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]-->
<link rel=apple-touch-icon-precomposed sizes=144x144 href=/assets/img/apple-touch-icon.png>
<link rel="shortcut icon" href=/assets/img/favicon.ico>
<link rel=stylesheet href=/assets/css/newsletter.css>
</head><body>
<div class=sidebar>
<div class=container>
<div class=sidebar-about>
<span class=site__title>
<a href=https://shyamjos.com/>
Shyam Jos
</a>
</span>
<div class=author-image>
<img src=https://shyamjos.com/assets/img/shyam_jos_photo.jpeg alt="Author Image" class="img--circle img--headshot element--center">
</div><p class=site__description>
Random Bits From A SRE/DevOps Engineer
</p></div><div class=collapsible-menu>
<input type=checkbox id=menuToggle>
<label for=menuToggle>Shyam Jos</label>
<div class=menu-content>
<div>
<ul class=sidebar-nav>
<li>
<a href=/>
<span>Blog</span>
</a>
</li><li>
<a href=/about/>
<span>About</span>
</a>
</li></ul></div><section class=social>
<a href=https://twitter.com/shyamjose rel=me><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a>
<a href=https://github.com/shyamjos rel=me><i class="fab fa-github fa-lg" aria-hidden=true></i></a>
<a href=https://linkedin.com/in/shyamjos rel=me><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a>
<a href=https://stackoverflow.com/users/2460764 rel=me><i class="fab fa-stack-overflow fa-lg" aria-hidden=true></i></a>
<a href=mailto:shyamjosepp+website@gmail.com rel=me><i class="fas fa-at fa-lg" aria-hidden=true></i></a>
</section></div></div><div class=copyright>
&copy; 2023 Shyam Jos
</div></div></div><div class="content container">
<article>
<header>
<h1>HPA - How to gracefully scale down pods with PreStop hooks</h1><div class=post__meta>
<i class="fas fa-calendar-alt" style=padding-right:2px></i> 30 Sep 2021
<br>
<i class="fas fa-tags"></i>
<a class="badge badge-tag" style=padding-right:1px href=/tags/kubernetes>kubernetes</a>
<a class="badge badge-tag" style=padding-right:1px href=/tags/container>container</a>
<br>
<i class="fas fa-clock" style=padding-right:2px></i> 2 min read
</div></header><div class=post>
<p>One of our application running in kubernetes have a background job feature (which is a bad practice and against stateless architecture) and recently we noticed some of these background jobs were killed in midway due to pod scale-down done by horizontal pod autoscaler. Our assumption was Kubernetes will only terminate pods with less utilization but we were wrong! and its a random selection.</p><p>In order to handle this issue we found out that we can use prestop hook feature in kubernetes to check for any background process running in container and wait for it to complete before sending termination signal.</p><h2 id=how-prestop-hooks-works-in-kubernetes>How PreStop hooks works in kubernetes</h2><p>Kubernetes provides container lifecycle hook framework to run code triggered by events during their management lifecycle called PostStart and PreStop hooks. A PreStop hook is called immediately before sending termination signal and kubernetes will wait until the PreStop hook to complete or until it exceed the <code>terminationGracePeriodSeconds</code> value, Only after this kubernetes will sent the termination signal to the container.</p><h2 id=our-solution>Our solution</h2><p>Our solution was to use a bash script for PreStop hook which will check for <code>.lock</code> files created by the background process, if it finds a <code>.lock</code> file the script will wait for the <code>.lock</code> file to be removed and when the file is removed the script will exit then the container will receive termination signal. If the PreStop hook takes more time than <code>terminationGracePeriodSeconds</code> value then container will be terminated immediately once this value is crossed.</p><h3 id=prestop-hook-bash-script>PreStop hook bash script</h3><pre tabindex=0><code>#PreStop Script for checking background php tasks 
SECONDS=0
while true
do	
if [ -z &#34;$(ls -A /app/demo-web/public/lock/*.lock 2&gt; /dev/null)&#34; ]; then
   echo &#34;No lock files found!, container is safe to terminate [Time Elapsed: ${SECONDS}s].&#34;
   exit 0
else
   echo &#34;Lock files found!, waiting for background process to complete [Time Elapsed: ${SECONDS}s].&#34;
   sleep 10
fi
done &gt; /proc/1/fd/1 # sent outputs to conatiner&#39;s stdout
</code></pre><h3 id=final-deployment-yaml>Final deployment yaml</h3><pre tabindex=0><code>apiVersion: apps/v1
kind: Deployment
metadata:
  name: demo-web
  namespace: production
spec:
  progressDeadlineSeconds: 300
  revisionHistoryLimit: 5
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 5
      maxUnavailable: 0
  selector:
    matchLabels:
      app: demo-web
      tier: web
      environment: production 
  template:
    metadata:
      labels:
        app: demo-web
        tier: web
        environment: production
    spec:
      terminationGracePeriodSeconds: 300
      containers:
      - name: demo-web
        image: demo/demoweb:v1
        lifecycle:
          preStop :
             exec:
               command: [&#34;bash&#34;, &#34;/app/scripts/prestop.sh&#34;]           
        imagePullPolicy: Always
        resources:
          requests:
            cpu: 50m
            memory: 150Mi
          limits:
            memory: &#34;650Mi&#34; 
        ports:
        - containerPort: 80
        readinessProbe:
         httpGet:
          path: /healthz
          port: 80
         initialDelaySeconds: 2
         periodSeconds: 5
         successThreshold: 1
         failureThreshold: 2
         timeoutSeconds: 2
        env:
         - name: HOST 
           value: &#34;demo.app.com&#34;
</code></pre></div><div id=mc_embed_signup class=newsletter>
<form action="https://shyamjos.us11.list-manage.com/subscribe/post?u=965be0bf90a8bd031bf02e3d2&id=2c71c7959b&f_id=00ad91e0f0" method=post id=mc-embedded-subscribe-form name=mc-embedded-subscribe-form class=validate target=_blank novalidate>
<div id=mc_embed_signup_scroll>
<h2 class=top-text-center>Subscribe to my weekly Newsletter</h2><div class=indicates-required><span class=asterisk>*</span> indicates required</div><div class=mc-field-group>
<label for=mce-EMAIL class=email-label>Email Address <span class=asterisk>*</span>
</label>
<input type=email name=EMAIL class=email id=mce-EMAIL>
</div><div style=position:absolute;left:-5000px aria-hidden=true><input type=text name=b_965be0bf90a8bd031bf02e3d2_2c71c7959b tabindex=-1></div><div class=optionalParent>
<div class="clear foot">
<input type=submit value=Subscribe name=subscribe id=mc-embedded-subscribe class=button>
<p class=bottom-text-center> No spam or ads. Unsubscribe whenever you want.</p></div></div></div></form></div><p></p><script type=text/javascript src=https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js data-name=bmc-button data-slug=shyamjos data-color=#deddda data-emoji data-font=Bree data-text="Buy me a coffee" data-outline-color=#000000 data-font-color=#000000 data-coffee-color=#FFDD00></script>
<div class=post__related>
<h2>Related Articles</h2><ul class=related-posts>
<li>
<span class=list__title--small>
<a href=/redirect-prestop-hook-logs/>How to redirect PreStop hook output to pod logs</a>
<time class="pull-right hidden-tablet">25 Sep 2021</time>
</span>
</li><li>
<span class=list__title--small>
<a href=/redirecting-codeigniter-logs-to-container-stdout-stderr/>Redirect CodeIgniter logs to container's STDOUT/ERR</a>
<time class="pull-right hidden-tablet">20 Aug 2021</time>
</span>
</li></ul></div></article></div><script defer src=https://use.fontawesome.com/releases/v5.12.1/js/all.js integrity=sha384-ZbbbT1gw3joYkKRqh0kWyRp32UAvdqkpbLedQJSlnI8iLQcFVxaGyrOgOJiDQTTR crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js></script>
<script type=text/javascript>hljs.initHighlightingOnLoad()</script>
</body></html>